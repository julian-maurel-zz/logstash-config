input {
    beats {
        port => "5044"
    }
}
filter {
	if [fields][log_type] == "catalina.out" {
		if "[Render] - Rendered" in [message] {
			grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<javaClass>[a-zA-Z\-0-9]+)\] - Rendered \[%{URIPATH:pagePath}\] user=\[%{WORD:username}\] .* in \[%{INT:renderTime:int}ms\]" ]
		    }
		    mutate {
		      add_field => { "jahialogtype" => "pageRendered" }
		    }		
	    } else if "Error code: 404" in [message] { 
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<threadname>[a-zA-Z\-0-9]+)\] (?<javaClass>[a-zA-Z\-0-9\.]+): \[Error code: 404]: [a-zA-Z ]+: %{URIPATH:pagePath}" ]
		    }
			mutate {
		      add_field => { "jahialogtype" => "error 404" }
		    }
	    } else if "Error code: 400" in [message] { 
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<threadname>[a-zA-Z\-0-9]+)\] (?<javaClass>[a-zA-Z\-0-9\.]+): \[Error code: 400]: %{GREEDYDATA:error}" ]
		    }
			mutate {
		      add_field => { "jahialogtype" => "error 400" }
		    }
	    } else if "[GC" in [message] or "[Full GC" in [message] { # should add non-timestamped GC management
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+T[0-9:\.]+\+[0-9]+): \[(?<gc_type>[a-zA-Z]+).*, %{NUMBER:gcDuration:float} secs" ]
		    }
			mutate {
		      add_field => { "jahialogtype" => "GC" }
		    }
	    } else if "evictExpiredCacheKeyJob" in [message] and "HTMLCache" in [message]  {
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<javaClass>[a-zA-Z\-0-9]+)\] - - %{INT:evictedHTMLCache:int}" ]
		    }
			mutate {
		      add_field => { "jahialogtype" => "evictHTMLCacheKeys" }
		    }
	    } else if "evictExpiredCacheKeyJob" in [message] and "from the caches" in [message]  {
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<javaClass>[a-zA-Z\-0-9]+)\] - Cleaned %{INT:evictedCaches:int}" ]
		    }
			mutate {
		      add_field => { "jahialogtype" => "evictCacheKeys" }
		    }
	    } 
	    #else if "ModuleFileInstallHandler" in [message] and "Processing FileInstall" in [message] or "Done processing FileInstall artifacts" in [message] {
	    #	grok {
		#       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<javaClass>[a-zA-Z\-0-9]+)\]%{GREEDYDATA:message}" ]
		#    }
	#		mutate {
#		      add_field => { "jahialogtype" => "moduleFileInstall" }
#		    }
#
#		       if "Processing FileInstall" in [message] {
#			     aggregate {
#			       task_id => "moduleInstall"
#			       code => "map['moduleDeploymentDuration'] = 0"
#			       map_action => "create"
#			     }
#			   }
#
#			   if "Done processing FileInstall artifacts" in [message] {
#			     aggregate {
#			       task_id => "moduleInstall"
#			       code => "event.set('moduleDeploymentDuration', map['moduleDeploymentDuration'])"
#			       map_action => "update"
#			       end_of_task => true
#			       timeout => 1200
#			     }
#			   }
#
#	    } 
	    else if "[AbstractBundlePersistenceManager] - cachename" in [message] {
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<javaClass>[a-zA-Z\-0-9]+)\] - cachename=%{WORD:cacheName}.*, elements=%{NUMBER:elements:int}, usedmemorykb=%{NUMBER:usedmemorykb:int}, maxmemorykb=%{NUMBER:maxmemorykb:int}, access=%{NUMBER:access:int}, miss=%{NUMBER:miss:int}" ]
		    }

	         if "_grokparsefailure" not in [tags] {
	            ruby {            
	                  code => "event['cacheRatio'] = event['miss'] / event['access']"      
	            }    
	        }
			mutate {
		      add_field => { "jahialogtype" => "bundleCacheStats" }
		    }
		### TODO
		# 2018-03-25 20:02:46,213: INFO [DocNumberCache] - size=131/1024, #accesses=4158, #hits=3458, #misses=700, cacheRatio=84%, size=131/1024, #accesses=4158, #hits=3458, #misses=700, cacheRatio=84% 
		# 2018-03-25 18:15:00,009: INFO [evictExpiredCacheKeyJob] - - 1 from cache HTMLDependenciesCache, - 1 from cache HTMLDependenciesCache
		# 2018-03-25 18:00:00,094: INFO [SchedulerService] - Background job JobHistoryPurgeJob (of type Maintenance) finished with status 'successful' in 27 ms, Background job JobHistoryPurgeJob (of type Maintenance) finished with status 'successful' in 27 ms
		# 2018-03-25 22:24:46,441: INFO  [ModuleFileInstallHandler] - Done processing FileInstall artifacts
		# 2018-03-25 22:26:46,664: INFO  [ModuleFileInstallHandler] - Processing FileInstall artifacts: 0 created, 1 modified, 0 deleted

	    } else {
	    	grok {
		       match => [ "message", "(?<timestamp_log>[0-9-]+ [0-9:]+,[0-9]+): (?<loglevel>[A-Za-z$_]+)%{SPACE}\[(?<threadname>[a-zA-Z\-0-9]+)\] (?<javaClass>[a-zA-Z\-0-9\.]+)%{GREEDYDATA:message}" ]
		    }
			mutate {
		      add_field => { "jahialogtype" => "unknown" }
		    }
	    }
	    if "_grokparsefailure" in [tags] {
				drop { }
		}
	    date {
			match => [ "timestamp_log", "YYYY-MM-dd HH:mm:ss,SSS" ]
			target => "@timestamp"
		} 
	}
	 if [fields][log_type] != "catalina.out" {
	    drop { }
	  }
	if [fields][log_type] == "apache" {
      grok {
        match => { "message" => ["%{IPORHOST:[apache2][access][remote_ip]} - %{DATA:[apache2][access][user_name]} \[%{HTTPDATE:[apache2][access][time]}\] \"%{WORD:[apache2][access][method]} %{DATA:[apache2][access][url]} HTTP/%{NUMBER:[apache2][access][http_version]}\" %{NUMBER:[apache2][access][response_code]} %{NUMBER:[apache2][access][body_sent][bytes]}( \"%{DATA:[apache2][access][referrer]}\")?( \"%{DATA:[apache2][access][agent]}\")?",
          "%{IPORHOST:[apache2][access][remote_ip]} - %{DATA:[apache2][access][user_name]} \\[%{HTTPDATE:[apache2][access][time]}\\] \"-\" %{NUMBER:[apache2][access][response_code]} -" ] }
        remove_field => "message"
      }
      mutate {
        add_field => { "read_timestamp" => "%{@timestamp}" }
      }
      date {
        match => [ "[apache2][access][time]", "dd/MMM/YYYY:H:m:s Z" ]
        remove_field => "[apache2][access][time]"
      }
      useragent {
        source => "[apache2][access][agent]"
        target => "[apache2][access][user_agent]"
        remove_field => "[apache2][access][agent]"
      }
      geoip {
        source => "[apache2][access][remote_ip]"
        target => "[apache2][access][geoip]"
      }
    }
}
output {
    elasticsearch {
     hosts => [ "localhost:9200" ]
     index => "filebeat-%{+YYYY.MM.dd}"
    } 
}